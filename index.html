<!doctype html>
<html lang="en">
<head>
  <script src="https://cdn.jsdelivr.net/npm/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Crypto Wallet</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#97a0b3;--accent:#7c3aed;--glass: rgba(255,255,255,0.04)}
    *{box-sizing:border-box}
    body{margin:0;font-family:'Poppins', 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;background:linear-gradient(180deg,#071025 0%, #071525 100%);color:#e6eef8;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
    .app{width:960px;max-width:100%}
    .card{position:relative;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:16px;padding:22px;box-shadow:0 8px 40px rgba(2,6,23,0.6);transition:all .3s ease}

    /* language switch fixed inside card (top-right) */
    .lang-switch{position:absolute;top:18px;right:18px;display:flex;gap:8px;z-index:1000}
    .lang-btn{background:var(--glass);border:none;border-radius:8px;padding:6px 10px;color:white;cursor:pointer;transition:background .2s;display:flex;align-items:center;gap:6px;font-size:13px}
    .lang-btn:hover{background:rgba(255,255,255,0.12)}

    form{display:flex;flex-direction:column;gap:12px}
    input[type=text],input[type=password],input[type=number]{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:12px;border-radius:10px;color:inherit;transition:border .15s;appearance:none;font-family:inherit}
    input:focus{border-color:var(--accent);outline:none}
    button.btn{padding:10px 14px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--accent),#5b21b6);cursor:pointer;color:white;font-weight:600;transition:transform .12s ease;font-family:inherit}
    button.btn:hover{transform:translateY(-3px)}
    small.muted{color:var(--muted)}

    .wallet-header{display:flex;justify-content:space-between;align-items:center}
    .user-badge{background:var(--glass);padding:8px 12px;border-radius:999px;color:#cfe0ff}
    .balances{display:flex;gap:14px;margin-top:18px}
    .balance-card{flex:1;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:14px;border-radius:12px}
    .assets{margin-top:18px;display: block;}

    /* asset list + custom thin scrollbar */
    .asset-list{background:var(--card);padding:12px;border-radius:12px;max-height:380px;overflow-y:auto}
    .asset-list::-webkit-scrollbar{width:8px}
    .asset-list::-webkit-scrollbar-track{background:transparent}
    .asset-list::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.06);border-radius:8px}

    .asset{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:10px;margin-bottom:10px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);transition:background .12s}
    .asset:hover{background:rgba(255,255,255,0.04)}
    .asset .left{display:flex;gap:12px;align-items:center}
    .coin-circle{width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:20px;background:linear-gradient(180deg,rgba(255,255,255,0.05),rgba(255,255,255,0.01))}

    .addr{word-break:break-all;background:white;padding:12px;border-radius:12px;color:#0b1220;max-width:100%;box-shadow:0 8px 30px rgba(2,6,23,0.5)}
    .qr-wrapper{display:flex;flex-direction:column;align-items:center;gap:10px;margin-top:12px}
    .qr-wrapper canvas{border-radius:16px;box-shadow:0 12px 40px rgba(2,6,23,0.6);padding:8px;background:white}

    .networks{display:flex;gap:8px;margin-top:12px}
    .net-btn{flex:1;padding:12px;border-radius:10px;background:rgba(255,255,255,0.06);border:none;color:white;cursor:pointer;transition:transform .12s,background .12s;font-family:inherit}
    .net-btn:hover{transform:translateY(-3px)}
    .net-btn.active{background:linear-gradient(90deg,var(--accent),#5b21b6)}

    /* modal centered */
    .modal-back{position:fixed;inset:0;background:rgba(3,6,14,0.6);display:flex;align-items:center;justify-content:center;animation:fadeIn .18s ease;z-index:999}
    .modal{width:520px;background:var(--card);padding:24px;border-radius:18px;animation:scaleIn .22s ease;box-shadow:0 12px 50px rgba(0,0,0,0.6)}
    @keyframes scaleIn{from{opacity:0;transform:scale(.94)}to{opacity:1;transform:scale(1)}}
    .modal h2{margin:0 0 14px;font-size:22px}
    .modal .btn-row{display:flex;justify-content:flex-end;gap:12px;margin-top:18px}

    @keyframes scaleOut {
  from { opacity:1; transform: scale(1); }
  to   { opacity:0; transform: scale(0.92); }
}

.qr-wrapper {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
  margin-top: 14px;
}

.qr-box {
  padding: 0;
  background: none;
  border-radius: 20px;
  box-shadow: none;
  animation: qrFadeIn 0.4s ease;
}

.qr-box canvas, 
.qr-box img {
  border-radius: 12px;
  display: block;
}

@keyframes qrFadeIn {
  from { opacity:0; transform: scale(0.9); }
  to   { opacity:1; transform: scale(1); }
}

/* COPY button —Å—Ç–∏–ª—å */
.copy-btn {
  background: linear-gradient(90deg, var(--accent), #5b21b6);
  border: none;
  padding: 8px 14px;
  border-radius: 10px;
  font-size: 14px;
  font-weight: 600;
  color: white;
  cursor: pointer;
  transition: transform 0.15s, box-shadow 0.2s;
}
.copy-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 3px 10px rgba(0,0,0,0.25);
}
.copy-btn.copied {
  background: #2ecc71;
}


    @keyframes scaleOut {
  from { opacity: 1; transform: scale(1); }
  to   { opacity: 0; transform: scale(0.94); }
}
@keyframes fadeOut {
  from { opacity: 1; }
  to   { opacity: 0; }
}


    input[type=number]::-webkit-outer-spin-button,
input[type=number]::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

/* —É–±–∏—Ä–∞–µ–º —Å—Ç—Ä–µ–ª–æ—á–∫–∏ –≤ Firefox */
input[type=number] {
  -moz-appearance: textfield;
}

.receipt-box {
  background: #fff;
  color: #222;
  border-radius: 14px;
  padding: 20px;
  max-width: 420px;
  width: 100%;
  box-shadow: 0 6px 25px rgba(0,0,0,0.3);
  font-family: monospace;
}

.receipt-header {
  text-align: center;
  font-size: 22px;
  font-weight: bold;
  margin-bottom: 16px;
  border-bottom: 1px dashed #999;
  padding-bottom: 10px;
}

.receipt-body {
  margin: 10px 0;
  border-bottom: 1px dashed #999;
  padding-bottom: 10px;
}

.receipt-row {
  display: flex;
  justify-content: space-between;
  font-size: 14px;
  padding: 6px 0;
}

.receipt-footer {
  margin-top: 10px;
  text-align: center;
}


/* ---- Deposit UI tweaks & copy animation ---- */
.deposit-qr { display:flex;flex-direction:column;align-items:center;margin:16px 0; }
.deposit-qr .qr-bg { background:white;padding:12px;border-radius:14px;box-shadow:0 12px 30px rgba(2,6,23,0.45); }
.addr-box{
  background:rgba(255,255,255,0.04);
  border-radius:10px;
  padding:10px 12px;
  display:flex;
  gap:10px;
  align-items:center;
  justify-content:space-between;
  margin-top:12px;
  min-width:240px;
  transition: box-shadow .18s ease, border .18s ease, transform .12s ease;
  border:1px solid rgba(255,255,255,0.03);
}
.addr-box .addr-text{
  font-weight:600;
  font-size:14px;
  word-break:break-all;
  color: #e6eef8;
  margin-right:8px;
}
.copy-btn{
  background:var(--accent);
  border:none;
  color:#fff;
  padding:8px 12px;
  border-radius:8px;
  cursor:pointer;
  font-size:14px;
  font-weight:700;
  font-family:inherit;
  transition: transform .12s ease, background .18s ease;
  box-shadow: 0 6px 18px rgba(124,58,237,0.14);
}
.copy-btn:active{ transform: scale(.98); }

.addr-box.copied{
  box-shadow: 0 6px 18px rgba(46,204,113,0.12);
  border:1px solid rgba(46,204,113,0.18);
  transform: translateY(-1px);
}

.addr-text.copied {
  color: #2ecc71;
  text-shadow: 0 0 8px rgba(46,204,113,0.7);
  transition: color 0.3s ease, text-shadow 0.3s ease;
}


.copy-btn.copied{ background: #2ecc71; box-shadow: 0 8px 20px rgba(46,204,113,0.16); }


    footer{margin-top:14px;color:var(--muted);font-size:13px;text-align:center}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}

    @media(max-width:880px){.assets{grid-template-columns:1fr}.modal{width:92%}}

/* ==== MOBILE FRIENDLY FIXES ==== */

/* –ß—Ç–æ–±—ã –∏–∫–æ–Ω–∫–∏ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç –Ω–µ —Å–ø–ª—é—â–∏–≤–∞–ª–∏—Å—å */
.coin-circle {
  flex-shrink: 0;
  width: 48px;
  height: 48px;
}

/* –•–µ–¥–µ—Ä –∫–æ—à–µ–ª—å–∫–∞ ‚Äî –ª–æ–≥–æ—Ç–∏–ø + –±–∞–ª–∞–Ω—Å + logout */
.wallet-header {
  flex-wrap: wrap;
  gap: 10px;
}
.wallet-header button {
  white-space: nowrap;
}

.qr-box {
  padding: 0;
  background: none;
  border-radius: 20px;
  box-shadow: none;
  display: flex;
  justify-content: center;
  align-items: center;
}

.login-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.logo {
  font-size: 20px;
  font-weight: 700;
  flex: 1;               /* —á—Ç–æ–±—ã –∑–∞–Ω–∏–º–∞–ª–æ –¥–æ—Å—Ç—É–ø–Ω–æ–µ –º–µ—Å—Ç–æ */
  white-space: nowrap;   /* –µ—Å–ª–∏ —Ö–æ—á–µ—à—å, –º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å –ø–µ—Ä–µ–Ω–æ—Å */
  overflow: hidden;      /* —á—Ç–æ–±—ã –Ω–µ –Ω–∞–ª–µ–∑–∞–ª–æ */
  text-overflow: ellipsis; /* –¥–ª–∏–Ω–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã –±—É–¥—É—Ç –æ–±—Ä–µ–∑–∞—Ç—å—Å—è —Å "..." */
}

#qr-wrap canvas {
  width: 300px;   /* –≤—Å–µ–≥–¥–∞ 300px –Ω–∞ —ç–∫—Ä–∞–Ω–µ */
  height: 300px;
}

/* –ë–∞–ª–∞–Ω—Å—ã ‚Äî –Ω–∞ –º–æ–±–∏–ª–µ –≤ –∫–æ–ª–æ–Ω–∫—É */
@media (max-width: 600px) {
  .balances {
    flex-direction: column;
  }
  .asset {
    flex-direction: column;
    align-items: flex-start;
    padding: 12px;
  }
  .asset .left {
    margin-bottom: 8px;
  }
}

/* –ú–æ–¥–∞–ª–∫–∏ ‚Äî –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–µ */
@media (max-width: 880px) {
  .modal {
    width: 92%;
  }
}

@media (max-width: 480px) {
  .modal {
    width: 95%;
    padding: 16px;
    border-radius: 12px;
  }
  .btn {
    padding: 8px 12px;
    font-size: 14px;
  }
  h2 {
    font-size: 18px;
  }
}



  </style>
  
</head>
<body>
  <div class="app card" id="app">

 
<div id="screen-login">
  <div class="login-header">
    <div class="logo">FLUX</div>
    <div class="lang-switch">
      <button class="lang-btn" data-lang="en">üá∫üá∏ EN</button>
      <button class="lang-btn" data-lang="ru">üá∑üá∫ RU</button>
    </div>
  </div>

  <h1 id="login-title">Crypto wallet</h1>
  <p class="lead" id="login-sub">Sign in with your credentials.</p>

  <form id="login-form">
    <input id="input-login" type="text" placeholder="Username" required />
    <input id="input-pass" type="password" placeholder="Password" required />
    <button class="btn" id="btn-login" type="submit">Sign in</button>
    <div id="login-error" style="color:#ffb4b4;margin-top:8px;display:none"></div>
  </form>
</div>

  <!-- üîπ –≠–∫—Ä–∞–Ω –∫–æ—à–µ–ª—å–∫–∞ -->
  <div id="screen-wallet" style="display:none">
    <div class="wallet-header">
      <div>
        <div style="font-size:13px;color:var(--muted)" id="welcome">Welcome,</div>
        <div style="font-weight:800;font-size:20px" id="ui-username">User</div>
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        <div class="user-badge" id="ui-email">email@user</div>
        <button class="btn" id="btn-logout"
          style="background:none;border:1px solid rgba(255,255,255,0.06);color:inherit">
          Logout
        </button>
      </div>
    </div>

    <div class="balances">
      <div class="balance-card">
        <div style="font-size:13px;color:var(--muted)" id="balance-label">Total balance (simulated)</div>
        <div style="font-size:26px;font-weight:800;margin-top:8px" id="ui-total">0.00 USD</div>
      </div>
    </div>

    <div class="assets">
      <div class="asset-list" id="asset-list"></div>
    </div>

<div id="tx-history" style="margin-top:24px">
  <h3 id="tx-title" style="margin-bottom:10px"></h3>
  <div id="tx-list" style="background:var(--card);padding:12px;border-radius:12px"></div>
</div>


 
  </div>



  <!-- üîπ –ú–æ–¥–∞–ª–∫–∞ -->
  <div id="modal" style="display:none"></div>

</div>






<script>
// --- CONFIG ---
// --- CONFIG (–∑–∞–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ä—ã–π) ---
const CONFIG = {
  // —Å–∏—Å—Ç–µ–º–Ω—ã–µ –æ–±—â–∏–µ –≤–µ—â–∏
  ratesUSD:{ BTC:27000, LTC:70, USDT:1.0, USDC:1.0, TON:2.0, ETH:1800, BNB:320 },
  icons:{ BTC:'‚Çø', LTC:'≈Å', USDT:'$', USDC:'‚óà', TON:'‚óé', ETH:'Œû', BNB:'‚í∑' },
  fullNames:{
    BTC:'Bitcoin', LTC:'Litecoin', USDT:'Tether (USDT)', USDC:'USD Coin', TON:'TON',
    ETH:'Ethereum', BNB:'Binance Coin'
  },
  // –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å–µ—Ç–∏ –¥–ª—è —Ç–∏–∫–µ—Ä–æ–≤ (—É–¥–æ–±–Ω–æ –¥–ª—è —Ñ–æ—Ä–º—ã)
  networks:{
    BTC:['Mainnet'],
    LTC:['Mainnet'],
    TON:['Mainnet'],
    USDT:['ERC20','TRC20','BEP20'],
    USDC:['ERC20'],
    ETH:['ERC20'],
    BNB:['BEP20']
  },

  // users ‚Äî —Ç–µ–ø–µ—Ä—å –∫–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö—Ä–∞–Ω–∏—Ç —Å–≤–æ–∏ –∫–æ—à–µ–ª—å–∫–∏ –∏ –±–∞–ª–∞–Ω—Å—ã
  users: []
};




// --- STATE ---
let STATE = {
  currentUser: null,
  userWallets: {},   // —Å—é–¥–∞ –ø–æ–¥ –ª–æ–≥–∏–Ω–æ–º –±—É–¥–µ–º –ø–æ–¥–≥—Ä—É–∂–∞—Ç—å –∞–¥—Ä–µ—Å–∞
  balances: {},      // —Å—é–¥–∞ –ø–æ–¥ –ª–æ–≥–∏–Ω–æ–º –±—É–¥–µ–º –ø–æ–¥–≥—Ä—É–∂–∞—Ç—å –±–∞–ª–∞–Ω—Å—ã
  selectedAsset: null,
  lang: 'en',
  currentModal: null,
  transactions: [],   // –º–∞—Å—Å–∏–≤ –∏—Å—Ç–æ—Ä–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
  txTimers: {},       // —Ç–∞–π–º–∞—É—Ç—ã (sent/completed)
  txIntervals: {}     // –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI
};


window.addEventListener('DOMContentLoaded', async ()=>{
  try {
    const res = await fetch('users.json?ts=' + Date.now());
    const data = await res.json();
    CONFIG.users = data.users; // –∑–∞–∫–∏–¥—ã–≤–∞–µ–º –≤ CONFIG
  } catch (err) {
    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ users.json:", err);
  }

  // –æ—Å—Ç–∞–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  document.querySelectorAll('.lang-btn').forEach(btn=>{
    btn.addEventListener('click', ()=> setLang(btn.dataset.lang));
  });
  $('login-form').addEventListener('submit', (e)=>{ e.preventDefault(); handleLogin(); });
  $('btn-logout').addEventListener('click', ()=>{ STATE.currentUser=null; resetToLogin(); });
  setLang('en');
});


function $(id){return document.getElementById(id)}
function formatAsset(amount,t){
  if(typeof amount === 'object'){
    const total = Object.values(amount).reduce((a,b)=>a+b,0);
    return total.toFixed(2)+' '+t;
  }
  if(t==='BTC'||t==='LTC')return amount.toFixed(8)+' '+t;
  if(t==='TON')return amount.toFixed(4)+' '+t;
  return amount.toFixed(2)+' '+t;
}

function usdValue(t,a){const r=CONFIG.ratesUSD[t]||0;return a*r}

const STR = {
  en: {
    open:'Open',deposit:'Deposit',withdraw:'Withdraw',close:'Close',send:'Send',
    select_network:'Select network',
    send_warning:'Send only on the selected network, otherwise funds may be lost.',
    use_addr:'Use this address to fund your balance',
    recipient:'Recipient address',
    amount:'Amount',
    balance:'Your balance',

    tx_details: 'Transaction details',
    tx_success: 'Transaction has been broadcast to the network and is awaiting confirmation.',
    tx_amount: 'Amount',
    tx_to: 'Recipient',
    tx_cancel: 'Refund',
    tx_cancelled: 'Transaction has been successfully cancelled. Funds including the network fee have been returned to your wallet.',
    tx_sent: "Sent",
    tx_completed: "Completed",
    done: 'Done',

    total: "Total",
    last_tx: "Latest transactions",
    no_tx: "No transactions",
    tx_pending: "Pending confirmation",
    tx_cancelled_short: "Refunded",
    fee: "Network fee",
    expires_in: "Time left to refund"
  },
  ru: {
    open:'–û—Ç–∫—Ä—ã—Ç—å',deposit:'–ü–æ–ø–æ–ª–Ω–∏—Ç—å',withdraw:'–í—ã–≤–µ—Å—Ç–∏',close:'–ó–∞–∫—Ä—ã—Ç—å',send:'–û—Ç–ø—Ä–∞–≤–∏—Ç—å',
    select_network:'–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ç—å',
    send_warning:'–û—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ —Ç–æ–ª—å–∫–æ –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å–µ—Ç–∏, –∏–Ω–∞—á–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ –º–æ–≥—É—Ç –±—ã—Ç—å —É—Ç–µ—Ä—è–Ω—ã.',
    use_addr:'–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–∞–Ω–Ω—ã–π –∞–¥—Ä–µ—Å –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞',
    recipient:'–ê–¥—Ä–µ—Å –ø–æ–ª—É—á–∞—Ç–µ–ª—è',
    amount:'–°—É–º–º–∞',
    balance:'–í–∞—à –±–∞–ª–∞–Ω—Å',

    tx_details: '–î–µ—Ç–∞–ª–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏',
    tx_success: '–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ —Å–µ—Ç—å –∏ –æ–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.',
    tx_amount: '–°—É–º–º–∞',
    tx_to: '–ü–æ–ª—É—á–∞—Ç–µ–ª—å',
    tx_cancel: '–û—Ç–º–µ–Ω–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é',
    tx_cancelled: '–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –æ—Ç–º–µ–Ω–µ–Ω–∞. –°—Ä–µ–¥—Å—Ç–≤–∞ –≤–º–µ—Å—Ç–µ —Å –∫–æ–º–∏—Å—Å–∏–µ–π –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã –Ω–∞ –≤–∞—à –∫–æ—à–µ–ª–µ–∫.',
    tx_sent: "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ",
    tx_completed: "–ó–∞–≤–µ—Ä—à–µ–Ω–æ",
    done: '–ì–æ—Ç–æ–≤–æ',

    total: "–í—Å–µ–≥–æ",
    last_tx: "–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏",
    no_tx: "–ù–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π",
    tx_pending: "–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è",
    tx_cancelled_short: "–û—Ç–º–µ–Ω–µ–Ω–∞",
    fee: "–ö–æ–º–∏—Å—Å–∏—è —Å–µ—Ç–∏",
    expires_in: "–û—Å—Ç–∞–≤—à–µ–µ—Å—è –≤—Ä–µ–º—è –¥–ª—è –æ—Ç–º–µ–Ω—ã"
  }
};

function validateAddress(ticker, network, addr) {
  if (!addr) return false;
  addr = addr.trim();

  switch (ticker) {
    case "BTC":
      // BTC –∞–¥—Ä–µ—Å–∞ (–Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å 1, 3 –∏–ª–∏ bc1)
      return /^(bc1|[13])[a-zA-HJ-NP-Z0-9]{25,39}$/.test(addr);

    case "LTC":
      // LTC –∞–¥—Ä–µ—Å–∞ (ltc1..., L..., M...)
      return /^(ltc1|[LM3])[a-km-zA-HJ-NP-Z1-9]{26,40}$/.test(addr);

    case "TON":
      // TON (Base64url —Ñ–æ—Ä–º–∞—Ç, –æ–±—ã—á–Ω–æ ~48 —Å–∏–º–≤–æ–ª–æ–≤)
      return /^[A-Za-z0-9\-_]{48,55}$/.test(addr);

    case "USDT":
    case "USDC":
      if (network === "ERC20" || ticker === "ETH") {
        // Ethereum ERC20 (0x + 40 hex —Å–∏–º–≤–æ–ª–æ–≤)
        return /^0x[a-fA-F0-9]{40}$/.test(addr);
      }
      if (network === "TRC20") {
        // Tron (–∞–¥—Ä–µ—Å–∞ T...)
        return /^T[1-9A-HJ-NP-Za-km-z]{33}$/.test(addr);
      }
      if (network === "BEP20" || ticker === "BNB") {
        // BNB BEP20 = —Ç–æ–∂–µ 0x... (–∫–∞–∫ Ethereum)
        return /^0x[a-fA-F0-9]{40}$/.test(addr);
      }
      return false;

    default:
      return false;
  }
}




function handleLogin(){
  const login = $('input-login').value.trim().toLowerCase();
  const pass = $('input-pass').value.trim();

  const u = CONFIG.users.find(x => 
    x.login.toLowerCase() === login && x.password === pass
  );

  if(!u){
    $('login-error').style.display='block';
    $('login-error').textContent = (STATE.lang==='ru'
      ? '–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å'
      : 'Invalid login or password');
    return;
  }

  $('login-error').style.display='none';
  STATE.currentUser = { login: u.login, displayName: u.displayName, email: u.email };
  STATE.userWallets = JSON.parse(JSON.stringify(u.wallets || {}));
  STATE.balances = JSON.parse(JSON.stringify(u.balances || {}));

  showWallet();
}



function getWalletAddress(ticker, net){
  // —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º STATE.userWallets (—Ç–µ–∫—É—â–∏–π —é–∑–µ—Ä)
  if(STATE.userWallets){
    const key = net ? `${ticker}_${net}` : ticker;
    if(STATE.userWallets[key]) return STATE.userWallets[key];
  }
  // fallback ‚Äî –µ—Å–ª–∏ –Ω—É–∂–µ–Ω –≥–ª–æ–±–∞–ª—å–Ω—ã–π fallback, –º–æ–∂–Ω–æ –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è –≤–∑—è—Ç—å –∏–∑ CONFIG (—Ä–µ–¥–∫–æ)
  if(CONFIG.wallets){
    const key2 = net ? `${ticker}_${net}` : ticker;
    return CONFIG.wallets[key2] || 'Address not set';
  }
  return 'Address not set';
}

function resetToLogin(){ $('screen-wallet').style.display='none'; $('screen-login').style.display='block'; }

function showWallet(){ 
  $('screen-login').style.display='none'; 
  $('screen-wallet').style.display='block'; 
  $('ui-username').textContent = STATE.currentUser.displayName; 
  $('ui-email').textContent = STATE.currentUser.email; 
  renderAssets(); 
  updateTotal();
  $('tx-title').textContent = STR[STATE.lang].last_tx; // ‚úÖ –ø–µ—Ä–µ–≤–æ–¥–∏–º—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫
  renderTransactions();
}



function renderAssets(){ 
  const list = $('asset-list'); 
  list.innerHTML = ''; 
  
  const tickers = Object.keys(STATE.balances);

  const order = ["BTC", "LTC", "USDT", "TON", "USDC", "ETH", "BNB"];

  // —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –Ω–∞—à–µ–º—É –ø–æ—Ä—è–¥–∫—É
  tickers.sort((a,b)=>{
    const ia = order.indexOf(a);
    const ib = order.indexOf(b);
    if(ia === -1 && ib === -1) return a.localeCompare(b);
    if(ia === -1) return 1;
    if(ib === -1) return -1;
    return ia - ib;
  });

  tickers.forEach(t=>{
    const row = document.createElement('div'); 
    row.className='asset'; 
    const fullname = CONFIG.fullNames[t] || t; 
    row.innerHTML = `
      <div class="left">
        <div class="coin-circle">${CONFIG.icons[t]||t[0]}</div>
        <div>
          <div style="font-weight:700">${t}</div>
          <div style="color:var(--muted);font-size:13px">
            ${STR[STATE.lang].balance} ${fullname}: ${formatAsset(STATE.balances[t],t)}
          </div>
        </div>
      </div>
      <div><button class="btn open-btn" data-ticker="${t}">${STR[STATE.lang].open}</button></div>`;
    list.appendChild(row); 
    row.querySelector('.open-btn').addEventListener('click', ()=> openAssetModal(t)); 
  }); 
}


// Modal helper: creates centered backdrop and modal content, tracks current modal type

function showModal(innerHtml, modalType=null, meta={}){
  const container = $('modal');
  container.innerHTML = '';
  const back = document.createElement('div'); back.className = 'modal-back';
  const modal = document.createElement('div'); modal.className = 'modal'; modal.innerHTML = innerHtml;
  back.appendChild(modal);
  container.appendChild(back);
  container.style.display = 'block';
  // close when clicking backdrop
  back.addEventListener('click', closeModal);
  modal.addEventListener('click', e=>e.stopPropagation());
  STATE.currentModal = Object.assign({type: modalType}, meta);
}

function cancelTransactionForTx(tx){
  if(tx.status === 'cancelled' || tx.status === 'refunded') return;

  tx.status = 'cancelled';
  renderTransactions();
  updateTotal(false); // üîπ –æ–±–Ω–æ–≤–∏—Ç—å –±–µ–∑ –∞–Ω–∏–º–∞—Ü–∏–∏
  closeModal();

  showMessage(STATE.lang==='ru' 
    ? '–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞. –°—Ä–µ–¥—Å—Ç–≤–∞ —Å–∫–æ—Ä–æ –±—É–¥—É—Ç –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã.' 
    : 'Transaction cancelled. Funds will be refunded shortly.'
  );

  // —á–µ—Ä–µ–∑ 12 —Å–µ–∫—É–Ω–¥ –≤–æ–∑–≤—Ä–∞—Ç
  setTimeout(()=>{
    if(tx.status === 'cancelled'){
      tx.status = 'refunded';

      if(typeof STATE.balances[tx.ticker] === 'object'){
        STATE.balances[tx.ticker][tx.net] = Number((STATE.balances[tx.ticker][tx.net] + tx.amount + tx.fee).toFixed(8));
      } else {
        STATE.balances[tx.ticker] = Number((STATE.balances[tx.ticker] + tx.amount + tx.fee).toFixed(8));
      }

      updateTotal();
      renderTransactions();

      showMessage(STATE.lang==='ru' 
        ? '–í–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤ –∑–∞—á–∏—Å–ª–µ–Ω.' 
        : 'Funds have been refunded.'
      );
    }
  }, 12000);
}





function openTransactionDetails(tx) {
  if (STATE.txIntervals && STATE.txIntervals[tx.id]) {
    clearInterval(STATE.txIntervals[tx.id]);
    delete STATE.txIntervals[tx.id];
  }

  const labelMap = {
    pending: STR[STATE.lang].tx_pending,
    sent: STATE.lang === 'ru' ? '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ' : 'Sent',
    completed: STATE.lang === 'ru' ? '–ó–∞–≤–µ—Ä—à–µ–Ω–æ' : 'Completed',
    cancelled: STR[STATE.lang].tx_cancelled_short,
    refunded: STATE.lang === 'ru' ? '–í–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤' : 'Refunded'
  };
  const colorMap = {
    pending: '#7c3aed',
    sent: '#2ecc71',
    completed: '#3498db',
    cancelled: '#ff4d4d',
    refunded: '#ff4d4d'
  };

  const statusLabel = labelMap[tx.status] || tx.status;
  const statusColor = colorMap[tx.status] || '#7c3aed';

  const remainingMs = tx.expiresAt - Date.now();
  const remainingMin = Math.max(0, Math.floor(remainingMs / 60000));
  const remainingSec = Math.max(0, Math.floor((remainingMs % 60000) / 1000));

  const inner = `
    <h2 style="margin-bottom:6px">${STR[STATE.lang].tx_details}</h2>
    <div style="margin-bottom:18px; font-weight:600; font-size:14px; color:${statusColor}">
      ‚óè ${statusLabel}
    </div>

    <div class="tx-row"><span>${STATE.lang==='ru'?'–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞':'Asset'}:</span><b>${CONFIG.fullNames[tx.ticker] || tx.ticker}</b></div>
    <div class="tx-row"><span>${STATE.lang==='ru'?'–°—É–º–º–∞':'Amount'}:</span><b>${tx.amount} ${tx.ticker} + ${tx.fee} ${tx.ticker} fee</b></div>
    <div class="tx-row"><span>${STATE.lang==='ru'?'–°–µ—Ç—å':'Network'}:</span>${tx.net}</div>
    <div class="tx-row"><span>${STATE.lang==='ru'?'–ê–¥—Ä–µ—Å –ø–æ–ª—É—á–∞—Ç–µ–ª—è':'Recipient'}:</span><span style="word-break:break-all">${tx.to}</span></div>
    <div class="tx-row"><span>ID:</span>${tx.internalId}</div>
    <div class="tx-row"><span>${STATE.lang==='ru'?'–î–∞—Ç–∞':'Date'}:</span>${new Date(tx.createdAt).toLocaleString()}</div>
    <div class="tx-row"><span>Hash:</span>
      <a href="https://tronscan.org/#/transaction/${tx.hash}" target="_blank" style="color:#4da3ff;text-decoration:none">
        ${tx.hash.slice(0,6)}...${tx.hash.slice(-6)}
      </a>
    </div>

    <div style="margin-top:14px;font-size:13px;color:#f1c40f" id="cancel-timer">
      ${STATE.lang==='ru'
        ? `–û—Å—Ç–∞–≤—à–µ–µ—Å—è –≤—Ä–µ–º—è –¥–ª—è –æ—Ç–º–µ–Ω—ã: ${remainingMin}:${remainingSec.toString().padStart(2,'0')}`
        : `Time left to refund: ${remainingMin}:${remainingSec.toString().padStart(2,'0')}`}
    </div>

    <div class="btn-row" style="margin-top:22px; display:flex; justify-content:space-between">
      <button class="btn" id="btn-close" style="background:#444">${STR[STATE.lang].close}</button>
      <button class="btn" id="btn-receipt" style="background:#2ecc71;display:flex;align-items:center;gap:6px">
        üßæ ${STATE.lang==='ru'?'–ß–µ–∫':'Receipt'}
      </button>
      <button class="btn" id="btn-cancel" style="background:#b33939; display:${(Date.now()<tx.expiresAt && tx.status!=='cancelled' && tx.status!=='refunded')?'inline-block':'none'}">
        ${STR[STATE.lang].tx_cancel}
      </button>
    </div>
  `;

  showModal(inner, 'txdetails', { id: tx.id, ticker: tx.ticker, net: tx.net });

  // —Å—Ç–∏–ª–∏–∑–∞—Ü–∏—è —Ä—è–¥–æ–≤
  document.querySelectorAll('.tx-row').forEach(el=>{
    el.style.cssText = `
      display:flex; 
      justify-content:space-between; 
      padding:6px 0; 
      font-size:14px; 
      border-bottom:1px dashed rgba(255,255,255,0.1)`;
    el.querySelector('span').style.color = "var(--muted)";
  });

  // —Ç–∞–π–º–µ—Ä
  STATE.txIntervals[tx.id] = setInterval(() => {
    const left = tx.expiresAt - Date.now();
    if (left <= 0) {
      clearInterval(STATE.txIntervals[tx.id]);
      document.getElementById('cancel-timer').textContent = STATE.lang==='ru'
        ? '–í—Ä–µ–º—è –¥–ª—è –æ—Ç–º–µ–Ω—ã –∏—Å—Ç–µ–∫–ª–æ'
        : 'Refund time expired';
      document.getElementById('btn-cancel').style.display = 'none';
    } else {
      const mm = Math.floor(left / 60000);
      const ss = Math.floor((left % 60000) / 1000);
      document.getElementById('cancel-timer').textContent = STATE.lang==='ru'
        ? `–û—Å—Ç–∞–≤—à–µ–µ—Å—è –≤—Ä–µ–º—è –¥–ª—è –æ—Ç–º–µ–Ω—ã: ${mm}:${ss.toString().padStart(2,'0')}`
        : `Time left to refund: ${mm}:${ss.toString().padStart(2,'0')}`;
    }
  }, 1000);

  // –∫–Ω–æ–ø–∫–∏
  document.getElementById('btn-close')?.addEventListener('click', closeModal);
  document.getElementById('btn-receipt')?.addEventListener('click', ()=> openReceiptModal(tx));
  document.getElementById('btn-cancel')?.addEventListener('click', ()=> {
    const confirmHtml = `
      <h2 style="margin-bottom:14px">${STATE.lang==='ru'?'–í—ã —É–≤–µ—Ä–µ–Ω—ã?':'Are you sure?'}</h2>
      <div style="background:rgba(255,255,255,0.04);
                  padding:12px 16px;
                  border-radius:10px;
                  margin-bottom:10px;
                  font-size:14px;
                  color:var(--muted)">
        ${STATE.lang==='ru'
          ? '–ï—Å–ª–∏ –≤—ã –æ—Ç–º–µ–Ω–∏—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é, —Å—Ä–µ–¥—Å—Ç–≤–∞ –≤–º–µ—Å—Ç–µ —Å –∫–æ–º–∏—Å—Å–∏–µ–π –±—É–¥—É—Ç –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.'
          : 'If you cancel the transaction, the funds along with the fee will be returned shortly.'}
      </div>
      <div class="btn-row" style="margin-top:20px;display:flex;gap:12px">
        <button class="btn" style="flex:1;background:#444" id="cancel-no">
          ${STATE.lang==='ru'?'–ù–µ—Ç':'No'}
        </button>
        <button class="btn" style="flex:1;background:#b33939" id="cancel-yes">
          ${STATE.lang==='ru'?'–î–∞, –æ—Ç–º–µ–Ω–∏—Ç—å':'Yes, cancel'}
        </button>
      </div>
    `;

    showModal(confirmHtml, 'confirmcancel', {id: tx.id});

    document.getElementById('cancel-no').addEventListener('click', ()=> {
      openTransactionDetails(tx);
    });
    document.getElementById('cancel-yes').addEventListener('click', ()=> {
      cancelTransactionForTx(tx);
    });
  });
}




function openReceiptModal(tx) {
  const labelMap = {
    pending: STR[STATE.lang].tx_pending,
    sent: STATE.lang === 'ru' ? '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ' : 'Sent',
    completed: STATE.lang === 'ru' ? '–ó–∞–≤–µ—Ä—à–µ–Ω–æ' : 'Completed',
    cancelled: STR[STATE.lang].tx_cancelled_short,
    refunded: STATE.lang === 'ru' ? '–í–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤' : 'Refunded'
  };
  const colorMap = {
    pending: '#7c3aed',
    sent: '#2ecc71',
    completed: '#3498db',
    cancelled: '#ff4d4d',
    refunded: '#ff4d4d'
  };

  const statusLabel = labelMap[tx.status] || tx.status;
  const statusColor = colorMap[tx.status] || '#7c3aed';

  const inner = `
    <h2 style="margin-bottom:16px;display:flex;align-items:center;gap:10px">
      üßæ ${STATE.lang==='ru'?'–ß–µ–∫ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏':'Transaction receipt'}
    </h2>

    <div style="background:rgba(255,255,255,0.03);padding:16px;border-radius:12px;">

      <div style="display:flex;justify-content:space-between;margin-bottom:8px">
        <span style="color:var(--muted)">${STATE.lang==='ru'?'–°—Ç–∞—Ç—É—Å':'Status'}</span>
        <span style="font-weight:600;color:${statusColor}">${statusLabel}</span>
      </div>

      <div style="display:flex;justify-content:space-between;margin-bottom:8px">
        <span style="color:var(--muted)">${STATE.lang==='ru'?'–°—É–º–º–∞':'Amount'}</span>
        <span style="font-weight:600">${tx.amount} ${tx.ticker} + ${tx.fee} ${tx.ticker} fee</span>
      </div>

      <div style="display:flex;justify-content:space-between;margin-bottom:8px">
        <span style="color:var(--muted)">${STATE.lang==='ru'?'–°–µ—Ç—å':'Network'}</span>
        <span style="font-weight:600">${tx.net}</span>
      </div>

      <div style="display:flex;justify-content:space-between;margin-bottom:8px;align-items:center">
        <span style="color:var(--muted)">${STATE.lang==='ru'?'–ê–¥—Ä–µ—Å –ø–æ–ª—É—á–∞—Ç–µ–ª—è':'Recipient address'}</span>
        <span 
          style="font-weight:600;text-align:right;max-width:60%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;cursor:pointer" 
          title="${tx.to}">
          ${tx.to.length > 16 ? tx.to.slice(0,8) + '...' + tx.to.slice(-6) : tx.to}
        </span>
      </div>

      <div style="display:flex;justify-content:space-between;margin-bottom:8px">
        <span style="color:var(--muted)">ID</span>
        <span style="font-weight:600">${tx.internalId}</span>
      </div>

      <div style="display:flex;justify-content:space-between;margin-bottom:8px">
        <span style="color:var(--muted)">${STATE.lang==='ru'?'–î–∞—Ç–∞':'Date'}</span>
        <span style="font-weight:600">${new Date(tx.createdAt).toLocaleString()}</span>
      </div>

      <div style="display:flex;justify-content:space-between">
        <span style="color:var(--muted)">${STATE.lang==='ru'?'–•—ç—à':'Hash'}</span>
        <a href="https://tronscan.org/#/transaction/${tx.hash}" target="_blank" 
           style="font-weight:600;color:#4da3ff;text-decoration:none">
          ${tx.hash.slice(0,6)}...${tx.hash.slice(-6)}
        </a>
      </div>
    </div>

    <div class="btn-row" style="margin-top:20px;display:flex;gap:12px">
      <button class="btn" style="flex:1;background:#444" id="receipt-back">
        ${STATE.lang==='ru'?'–ù–∞–∑–∞–¥':'Back'}
      </button>
      <button class="btn" style="flex:1;background:#2ecc71" id="btn-close">
        ${STATE.lang==='ru'?'–ó–∞–∫—Ä—ã—Ç—å':'Close'}
      </button>
    </div>
  `;

  showModal(inner, 'receipt', { id: tx.id });

  // –ù–∞–∑–∞–¥ ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ Transaction details
  document.getElementById('receipt-back').addEventListener('click', ()=> {
    openTransactionDetails(tx);
  });

  // –ó–∞–∫—Ä—ã—Ç—å
  document.getElementById('btn-close').addEventListener('click', closeModal);
}









function openAssetModal(t){
  STATE.selectedAsset = t;
  const fullname = CONFIG.fullNames[t] || t;

  let balanceHtml = '';
  if (typeof STATE.balances[t] === 'object') {
    const total = Object.values(STATE.balances[t]).reduce((a,b)=>a+b,0);
    balanceHtml += `<div style="margin-bottom:12px">
      <strong>${STR[STATE.lang].total} ${fullname}:</strong> ${total.toFixed(2)} ${t}
    </div>`;
    balanceHtml += `<div style="margin-bottom:12px">`;
    Object.keys(STATE.balances[t]).forEach(net=>{
      balanceHtml += `
        <div style="font-size:14px; margin:4px 0; padding:6px 10px; background:rgba(255,255,255,0.04); border-radius:8px">
          <strong>${net}</strong>: ${STATE.balances[t][net].toFixed(2)} ${t}
        </div>`;
    });
    balanceHtml += `</div>`;
  } else {
    balanceHtml = `<div style="margin-bottom:12px">${STR[STATE.lang].balance} ${fullname}: ${formatAsset(STATE.balances[t],t)}</div>`;
  }

  const inner = `
    <h2>${t}</h2>
    ${balanceHtml}
    <div style='display:flex;gap:8px'>
      <button class='btn' id='modal-deposit'>${STR[STATE.lang].deposit}</button>
      <button class='btn' id='modal-withdraw'>${STR[STATE.lang].withdraw}</button>
    </div>
    <div class='btn-row' style='margin-top:14px;justify-content:flex-end;display:flex'>
      <button class='btn' style='background:#444' id='modal-close'>${STR[STATE.lang].close}</button>
    </div>`;

  showModal(inner, 'asset', {ticker:t});

  // üîπ –ù–∞–≤–µ—à–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –º–æ–¥–∞–ª–∫–∞ —Ä–µ–∞–ª—å–Ω–æ –≤ DOM
  setTimeout(()=>{
    const depBtn = document.getElementById('modal-deposit');
    const wdBtn  = document.getElementById('modal-withdraw');
    const closeBtn = document.getElementById('modal-close');
    if(depBtn) depBtn.onclick = ()=> showDeposit(t);
    if(wdBtn) wdBtn.onclick = ()=> showWithdraw(t);
    if(closeBtn) closeBtn.onclick = closeModal;
  },0);
}




function showDeposit(t){ 
    currentQR = null; // üîπ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º QR –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∑–∞–Ω–æ–≤–æ
  const nets = CONFIG.networks[t] || []; 
  let netButtons = '';
  if(nets.length>0){ 
    netButtons = `<div class='networks'>${nets.map((n,i)=>`<button class='net-btn ${i===0?'active':''}' data-net='${n}'>${n}</button>`).join('')}</div>`; 
  }

  const inner = `
    <div style="margin-bottom:12px">
      <button id="go-back" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:14px">
        ‚Üê ${STATE.lang==='ru'?'–ù–∞–∑–∞–¥':'Back'}
      </button>
    </div>
    <h2>${STR[STATE.lang].deposit} ${t}</h2>
    ${netButtons}
    <div style='margin-top:12px'>${STR[STATE.lang].use_addr}:</div>

    <div class="qr-wrapper">
      <div id="qr-wrap" class="qr-box"></div>
      <div class="addr-box" id="addr-box">
        <div class="addr-text" id="dep-addr"></div>
        <button id="copy-addr" class="copy-btn">Copy</button>
      </div>
    </div>

    <div class='btn-row' style="margin-top:18px">
      <button class='btn' style='background:#444' id='dep-close'>${STR[STATE.lang].close}</button>
    </div>`;

  showModal(inner, 'deposit', {ticker:t, net: nets.length>0?nets[0]:null});

  // –∫–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥
  document.getElementById('go-back').addEventListener('click', ()=> openAssetModal(t));
  // –∫–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç—å
  document.getElementById('dep-close').addEventListener('click', closeModal);

  // –≤—ã–±–æ—Ä —Å–µ—Ç–∏
  if(nets.length>0){ 
    document.querySelectorAll('.net-btn').forEach(btn=>btn.addEventListener('click', ()=>{
      document.querySelectorAll('.net-btn').forEach(b=>b.classList.remove('active')); 
      btn.classList.add('active'); 
      updateDepositAddress(t, btn.dataset.net); 
    })); 
  }

  // –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–¥—Ä–µ—Å–∞ + –∑–µ–ª—ë–Ω–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ üîπ
  const copyBtn = document.getElementById('copy-addr');
  const addrBox = document.getElementById('addr-box');
  copyBtn.addEventListener('click', ()=>{
    const addr = document.getElementById('dep-addr').textContent;
    navigator.clipboard.writeText(addr).then(()=>{
      copyBtn.classList.add("copied");
      copyBtn.textContent = STATE.lang==='ru' ? "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ" : "Copied";
      addrBox.classList.add("copied"); // –∑–µ–ª—ë–Ω–∞—è —Ä–∞–º–∫–∞ –∏ —Ç–µ–Ω—å

      setTimeout(()=>{
        copyBtn.classList.remove("copied");
        copyBtn.textContent = "Copy";
        addrBox.classList.remove("copied");
      },1500);
    });
  });

  // —Å—Ä–∞–∑—É –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å –∞–¥—Ä–µ—Å –∏ QR
  updateDepositAddress(t, (nets.length>0?nets[0]:null));
}




// –≥–ª–æ–±–∞–ª—å–Ω–æ –æ–±—ä—è–≤–∏ –æ–¥–∏–Ω —Ä–∞–∑:
let currentQR = null;

async function updateDepositAddress(t, net) {
  const keyNet = net || null;
  const addr = getWalletAddress(t, keyNet);
  const addrEl = document.getElementById('dep-addr');
  const qrWrap = document.getElementById('qr-wrap');

  if (addrEl) addrEl.textContent = addr;
  if (!qrWrap) return;

  // –∑–∞—â–∏—Ç–∞: –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞
  if (typeof QRCodeStyling === 'undefined') {
    console.error('QRCodeStyling is not loaded');
    qrWrap.textContent = 'QR lib missing';
    return;
  }

  // –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π –ª–æ–≥–æ—Ç–∏–ø –∏ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –≤ dataURL (—á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å CORS)
  async function toDataURL(src) {
    return new Promise((resolve) => {
      const img = new Image();
      img.crossOrigin = 'anonymous';
      img.onload = () => {
        try {
          const c = document.createElement('canvas');
          c.width = img.naturalWidth;
          c.height = img.naturalHeight;
          const ctx = c.getContext('2d');
          ctx.drawImage(img, 0, 0);
          resolve(c.toDataURL('image/png'));
        } catch (e) {
          resolve(null);
        }
      };
      img.onerror = () => resolve(null);
      img.src = src;
    });
  }

  const logoPath = 'flux-logo.png'; // —Ç–≤–æ–π —Ñ–∞–π–ª –≤ —Ç–æ–π –∂–µ –ø–∞–ø–∫–µ
  const logoData = await toDataURL(logoPath);
  const imageOption = logoData || null;

  if (!currentQR) {
    // –ø–µ—Ä–≤—ã–π —Ä–∞–∑ —Å–æ–∑–¥–∞—ë–º
currentQR = new QRCodeStyling({
  width: 600,   // —Ä–µ–Ω–¥–µ—Ä–∏–º –≤ –±–æ–ª—å—à–æ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–∏
  height: 600,
  type: "canvas",
  scale: 8,     // –µ—â—ë —Å–∏–ª—å–Ω–µ–µ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä—É–µ–º
  data: addr,
  image: imageOption,
  dotsOptions: { color: "#7c3aed", type: "rounded" },
  backgroundOptions: { color: "transparent" },
  imageOptions: {
    crossOrigin: "anonymous",
    margin: 8,
    hideBackgroundDots: true,
    imageSize: 0.18
  }
});



    qrWrap.innerHTML = '';
    currentQR.append(qrWrap);
  } else {
    // –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—ã–∑–æ–≤ ‚Üí –ø—Ä–æ—Å—Ç–æ –º–µ–Ω—è–µ–º –∞–¥—Ä–µ—Å
    currentQR.update({ data: addr });
  }
}




function showWithdraw(t){
  const nets = CONFIG.networks[t] || [];
  let activeNet = nets.length > 0 ? nets[0] : "Mainnet";

  const getBalance = (ticker, net)=>{
    if(typeof STATE.balances[ticker] === 'object'){
      return STATE.balances[ticker][net] || 0;
    }
    return STATE.balances[ticker];
  };

  let netButtons='';
  if(nets.length>0){
    netButtons = `<div class='networks'>${nets.map((n,i)=>
      `<button class='net-btn ${i===0?'active':''}' data-net='${n}'>${n}</button>`
    ).join('')}</div>`;
  }

  // üîπ –≤–æ—Ç —ç—Ç–æ –æ–∫–Ω–æ —Ñ–æ—Ä–º—ã –≤—ã–≤–æ–¥–∞
  const inner = `
    <div style="margin-bottom:12px">
      <button id="go-back" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:14px">
        ‚Üê ${STATE.lang==='ru'?'–ù–∞–∑–∞–¥':'Back'}
      </button>
    </div>
    <h2>${STR[STATE.lang].withdraw} ${t}</h2>
    ${netButtons}
    <div style='margin-top:12px;font-size:14px;color:var(--muted)'>
      ${STR[STATE.lang].balance}: 
      <span id="wd-balance">${getBalance(t,activeNet).toFixed(2)} ${t}</span>
    </div>

    <div style='margin-top:12px'>${STR[STATE.lang].recipient}:</div>
    <input type='text' id='wd-addr' placeholder='Address' 
      style='width:100%;padding:10px;border-radius:8px;
      background:transparent;border:1px solid rgba(255,255,255,0.06)' />

    <div style='margin-top:12px'>${STR[STATE.lang].amount}:</div>
    <input type='number' id='wd-amt' placeholder='0.00' 
      style='width:100%;padding:10px;border-radius:8px;
      background:transparent;border:1px solid rgba(255,255,255,0.06)' />

    <div style='margin-top:12px;font-size:13px;color:#f39c12'>
      ${STATE.lang==='ru' ? '–ö–æ–º–∏—Å—Å–∏—è: 6.5 USDT' : 'FEE: 6.5 USDT'}
    </div>

    <div style='margin-top:12px;font-size:13px;color:var(--muted)'>
      ${STR[STATE.lang].send_warning}
    </div>

    <div class='btn-row'>
      <button class='btn' style='background:#444' id='wd-cancel'>${STR[STATE.lang].close}</button>
      <button class='btn' id='wd-send'>${STR[STATE.lang].send}</button>
    </div>
  `;

  showModal(inner, 'withdraw', {ticker:t, net:activeNet});

  document.getElementById('go-back').addEventListener('click', ()=> openAssetModal(t));

  if(nets.length>0){
    document.querySelectorAll('.net-btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.net-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        STATE.currentModal.net = btn.dataset.net;
        $('wd-balance').textContent = getBalance(t,btn.dataset.net).toFixed(2)+" "+t;
      });
    });
  }

  document.getElementById('wd-cancel').addEventListener('click', closeModal);
  document.getElementById('wd-send').addEventListener('click', ()=> {
    const amt = Number(document.getElementById('wd-amt').value || 0); 
    const addr = document.getElementById('wd-addr').value || ''; 
    const net = STATE.currentModal.net || "Mainnet";
    const bal = getBalance(t, net);

    const minRequired = 5 + 6.5; // –º–∏–Ω–∏–º—É–º 11.5

    if(bal < minRequired){
      showMessage(STATE.lang==='ru'
        ? '–î–ª—è –≤—ã–≤–æ–¥–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∏–º–µ—Ç—å –º–∏–Ω–∏–º—É–º 11.5 USDT –Ω–∞ –±–∞–ª–∞–Ω—Å–µ'
        : 'You must have at least 11.5 USDT balance to withdraw');
      return;
    }

    if(!amt || amt<=0){ 
      showMessage(STATE.lang==='ru'?'–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—É—é —Å—É–º–º—É':'Enter a positive amount'); 
      return; 
    }

    if(amt + 6.5 > bal){ 
      showMessage(STATE.lang==='ru'?'–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ (–≤–∫–ª—é—á–∞—è –∫–æ–º–∏—Å—Å–∏—é)':'Insufficient balance (including fee)'); 
      return; 
    }

    const addrShort = addr.length > 10 ? (addr.slice(0,6) + "..." + addr.slice(-4)) : addr;
    const fullname = CONFIG.fullNames[t] || t;

    // üîπ –≤–æ—Ç –∑–¥–µ—Å—å confirmHtml
    const confirmHtml = `
      <h2>${STATE.lang==='ru'?'–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ':'Confirmation'}</h2>
      <div style="background:rgba(255,255,255,0.04);padding:12px 16px;border-radius:10px;margin-bottom:10px">
        <div style="font-size:12px;color:var(--muted)">${STATE.lang==='ru'?'–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞':'Asset'}</div>
        <div style="font-weight:600">${fullname} (${t})</div>
      </div>
      <div style="background:rgba(255,255,255,0.04);padding:12px 16px;border-radius:10px;margin-bottom:10px">
        <div style="font-size:12px;color:var(--muted)">${STATE.lang==='ru'?'–°—É–º–º–∞':'Amount'}</div>
        <div style="font-weight:600">${amt} ${t} + 6.5 ${t} fee</div>
      </div>
      <div style="background:rgba(255,255,255,0.04);padding:12px 16px;border-radius:10px;margin-bottom:10px">
        <div style="font-size:12px;color:var(--muted)">${STATE.lang==='ru'?'–°–µ—Ç—å':'Network'}</div>
        <div style="font-weight:600">${net}</div>
      </div>
      <div style="background:rgba(255,255,255,0.04);padding:12px 16px;border-radius:10px">
        <div style="font-size:12px;color:var(--muted)">${STATE.lang==='ru'?'–ö–æ—à–µ–ª—ë–∫ –ø–æ–ª—É—á–∞—Ç–µ–ª—è':'Recipient address'}</div>
        <div style="font-weight:600">${addrShort}</div>
      </div>
      <div class="btn-row" style="margin-top:20px;display:flex;gap:12px">
        <button class="btn" style="flex:1;background:#444" id="btn-no">${STATE.lang==='ru'?'–û—Ç–º–µ–Ω–∞':'Cancel'}</button>
        <button class="btn" style="flex:1;background:#2ecc71" id="btn-yes">${STATE.lang==='ru'?'–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å':'Confirm'}</button>
      </div>
    `;
    showModal(confirmHtml, 'confirm', {ticker:t, net:net, addr:addr, amt:amt});

    document.getElementById('btn-no').addEventListener('click', ()=> showWithdraw(t));
    document.getElementById('btn-yes').addEventListener('click', ()=> simulateSend(t, net, amt, addr));
  });
}




// ---- –í–°–¢–ê–í–¨ –≠–¢–û –í–ú–ï–°–¢–û –°–¢–ê–†–û–ô validateAddress + simulateSend ----

const EVM_NETS = ['ERC20','BEP20']; // —Å–µ—Ç–∏, –≥–¥–µ –∞–¥—Ä–µ—Å–∞ 0x...

function validateAddress(ticker, network, addr) {
  if (!addr) return false;
  addr = addr.trim();
  // —É–±—Ä–∞—Ç—å —Å—Ö–µ–º—ã —Ç–∏–ø–∞ "ethereum:0x..." –∏–ª–∏ "tron:"
  addr = addr.replace(/^[a-zA-Z]+:/, '');
  const net = (network || '').toUpperCase();

  // EVM-–ø–æ–¥–æ–±–Ω—ã–µ (ETH, ERC20, BEP20 –∏ —Ç.–ø.) ‚Äî 0x + 40 hex
  if (ticker === 'ETH' || EVM_NETS.includes(net) || ticker === 'BNB' && net === 'BEP20') {
    return /^0x[a-fA-F0-9]{40}$/.test(addr);
  }

  // USDT / USDC: –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —Å–µ—Ç—è—Ö
  if (ticker === 'USDT' || ticker === 'USDC') {
    if (net === 'ERC20' || net === 'BEP20') return /^0x[a-fA-F0-9]{40}$/.test(addr);
    if (net === 'TRC20') return /^T[1-9A-HJ-NP-Za-km-z]{33}$/.test(addr); // –±–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ Tron
    return false;
  }

  // Tron (–µ—Å–ª–∏ –≤–¥—Ä—É–≥ –ø–µ—Ä–µ–¥–∞—ë—à—å TRC20 –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ç–∏–∫–µ—Ä–æ–≤)
  if (net === 'TRC20') {
    return /^T[1-9A-HJ-NP-Za-km-z]{33}$/.test(addr);
  }

  // BTC ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∫–∞ legacy/segwit/bech32
  if (ticker === 'BTC') {
    return /^(bc1[ac-hj-np-z02-9]{11,71}|[13][a-km-zA-HJ-NP-Z1-9]{25,34})$/i.test(addr);
  }

  // LTC ‚Äî legacy/segwit (–ø—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)
  if (ticker === 'LTC') {
    return /^(ltc1[ac-hj-np-z02-9]{11,71}|[LM3][a-km-zA-HJ-NP-Z1-9]{25,34})$/i.test(addr);
  }

  // TON ‚Äî –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–∞—è (base64url-like) –ø—Ä–æ–≤–µ—Ä–∫–∞ ‚Äî –¥–æ–ø—É—Å–∫–∞–µ—Ç —Ç–∏–ø–∏—á–Ω—ã–µ TON-–∞–¥—Ä–µ—Å–∞
  if (ticker === 'TON') {
    return /^[A-Za-z0-9\-_]{40,90}$/.test(addr);
  }

  // BNB BEP2 (–µ—Å–ª–∏ –∫–æ–≥–¥–∞-–Ω–∏–±—É–¥—å –¥–æ–±–∞–≤–∏—à—å BEP2 —Å–µ—Ç–∏) ‚Äî –Ω–µ —Å—Ç–∞–≤–ª—é —Å—Ç—Ä–æ–≥—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –∑–¥–µ—Å—å,
  // –¥–ª—è —Ç–µ–∫—É—â–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ BNB –∏—Å–ø–æ–ª—å–∑—É–µ—Ç BEP20 (0x...), –ø–æ—ç—Ç–æ–º—É –≤—ã—à–µ —É–∂–µ –ø–æ–∫—Ä—ã—Ç–æ.
  if (ticker === 'BNB') {
    // –µ—Å–ª–∏ –Ω–µ BEP20 ‚Äî –ø—Ä–æ–±—É–µ–º –ø—Ä–æ—Å—Ç—É—é –ø—Ä–æ–≤–µ—Ä–∫—É bnb1... (bech32)
    if (net === 'BEP2' || addr.toLowerCase().startsWith('bnb1')) {
      return /^bnb1[qpzry9x8gf2tvdw0s3jn54khce6mua7l]{38}$/i.test(addr);
    }
    return /^0x[a-fA-F0-9]{40}$/.test(addr);
  }

  // fallback ‚Äî –µ—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ–º —Ç–∏–∫–µ—Ä/—Å–µ—Ç—å ‚Äî –Ω–µ –≤–∞–ª–∏–¥–∏—Ä—É–µ–º
  return false;
}


function simulateSend(t, net, amt, addr){
  const fee = 6.5; // —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∫–æ–º–∏—Å—Å–∏—è
  const getBalance = () => (typeof STATE.balances[t] === 'object' ? STATE.balances[t][net] : STATE.balances[t]);
  const bal = getBalance();

  // --- –í–ê–õ–ò–î–ê–¶–ò–Ø –ê–î–†–ï–°–ê ---
  if (!validateAddress(t, net, addr)) {
    showMessage(STATE.lang === 'ru'
      ? '–ù–µ–≤–µ—Ä–Ω—ã–π –∞–¥—Ä–µ—Å –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å–µ—Ç–∏!'
      : 'Invalid address for selected network!');
    return;
  }

  // –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É–º–º—ã
  if(amt + fee < 11.5){
    showMessage(STATE.lang==='ru'
      ? '–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –≤—ã–≤–æ–¥–∞ 5 USDT + –∫–æ–º–∏—Å—Å–∏—è 6.5 USDT'
      : 'Minimum withdrawal is 5 USDT + 6.5 USDT fee');
    return;
  }
  if(amt + fee > bal){
    showMessage(STATE.lang==='ru'?'–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤':'Insufficient balance');
    return;
  }

  // —Å–ø–∏—Å—ã–≤–∞–µ–º –±–∞–ª–∞–Ω—Å
  if(typeof STATE.balances[t] === 'object'){
    STATE.balances[t][net] = Number((bal - (amt + fee)).toFixed(8));
  } else {
    STATE.balances[t] = Number((bal - (amt + fee)).toFixed(8));
  }

  // –≥–µ–Ω–µ—Ä–∏–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç—Ä–∞–Ω–∑—ã
  const randomId = "#W" + Math.floor(1000000 + Math.random()*9000000);
  const hash = "4d860ed3a15907ca7792e9b8557ac53129db6ba591a3fa6d905690dcf91e8751";

  const tx = {
    id: Date.now(),
    ticker: t,
    net: net,
    amount: amt,
    fee: fee,
    to: addr,
    status: "pending",
    createdAt: Date.now(),
    expiresAt: Date.now() + (30 * 60 * 1000), // 30 –º–∏–Ω—É—Ç –Ω–∞ –æ—Ç–º–µ–Ω—É
    internalId: randomId,
    hash: hash
  };

  STATE.transactions.unshift(tx);
  if(STATE.transactions.length > 50) STATE.transactions.pop(); // –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–æ—Ç–æ–ª–æ–∫

  renderAssets();
  updateTotal();
  renderTransactions();

  // –æ—Ç–∫—Ä—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏ –æ–¥–∏–Ω —Ä–∞–∑
  openTransactionDetails(tx);

  // –¢–∞–π–º–µ—Ä—ã –∂–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:
  STATE.txTimers[tx.id] = {};
  STATE.txTimers[tx.id].toSent = setTimeout(()=>{ if(tx.status === 'pending'){ tx.status = 'sent'; renderTransactions(); } }, 12000);
  STATE.txTimers[tx.id].toCompleted = setTimeout(()=>{ if(tx.status !== 'cancelled' && tx.status !== 'refunded'){ tx.status = 'completed'; renderTransactions(); } }, 35000);
}

function renderTransactions(){
  const list = $('tx-list');
  if(STATE.transactions.length === 0){
    list.innerHTML = `<div style="color:var(--muted);font-size:14px">${STR[STATE.lang].no_tx}</div>`;
    return;
  }
  list.innerHTML = '';
  STATE.transactions.forEach(tx=>{
    const row = document.createElement('div');
    row.style.cssText = "padding:10px;border-bottom:1px solid rgba(255,255,255,0.06);cursor:pointer;display:flex;justify-content:space-between;align-items:center";

    const labelMap = {
      pending: STR[STATE.lang].tx_pending,
      sent: STATE.lang === 'ru' ? '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ' : 'Sent',
      completed: STATE.lang === 'ru' ? '–ó–∞–≤–µ—Ä—à–µ–Ω–æ' : 'Completed',
      cancelled: STR[STATE.lang].tx_cancelled_short,
      refunded: STATE.lang==='ru' ? '–í–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤' : 'Refunded'
    };
    const colorMap = {
      pending: '#7c3aed',
      sent: '#2ecc71',
      completed: '#3498db',
      cancelled: '#ff4d4d',
      refunded: '#ff4d4d'
    };

    const statusLabel = labelMap[tx.status] || tx.status;
    const statusColor = colorMap[tx.status] || '#7c3aed';

    row.innerHTML = `
      <div>
        <strong>${tx.ticker}</strong> ‚Ä¢ ${tx.amount} ${tx.ticker} ‚Üí ${tx.to.slice(0,6)}...
      </div>
      <div style="font-size:12px;color:${statusColor}">${statusLabel}</div>
    `;
    row.addEventListener('click', ()=> openTransactionDetails(tx));
    list.appendChild(row);
  });
}


function animateNumber(el, from, to, duration=800) {
  const start = performance.now();
  const isIncrease = to > from;

  // –ø–æ–¥—Å–≤–µ—Ç–∫–∞ + —Ç–µ–Ω—å
  el.style.transition = "color 0.3s ease, text-shadow 0.3s ease";
  if (isIncrease) {
    el.style.color = "#2ecc71";
    el.style.textShadow = "0 0 12px rgba(46,204,113,0.8)";
  } else {
    el.style.color = "#e74c3c";
    el.style.textShadow = "0 0 12px rgba(231,76,60,0.8)";
  }

  function step(ts) {
    const progress = Math.min((ts - start) / duration, 1);
    const val = from + (to - from) * progress;
    el.textContent = '$' + val.toFixed(2);
    if (progress < 1) {
      requestAnimationFrame(step);
    } else {
      // –º—è–≥–∫–æ–µ –∑–∞—Ç—É—Ö–∞–Ω–∏–µ —Å–≤–µ—á–µ–Ω–∏—è
      el.style.transition = "color 0.8s ease, text-shadow 1s ease";
      el.style.color = "#e6eef8";
      el.style.textShadow = "0 0 0 rgba(0,0,0,0)";
    }
  }

  requestAnimationFrame(step);
}




function updateTotal(animated = true){
  let tot = 0;

  Object.keys(STATE.balances).forEach(t=>{
    if(typeof STATE.balances[t] === 'object'){
      Object.values(STATE.balances[t]).forEach(v=>{ tot += usdValue(t, v); });
    } else {
      tot += usdValue(t, STATE.balances[t]);
    }
  });

  const el = $('ui-total');
  const current = parseFloat(el.textContent.replace(/[^0-9.-]/g,"")) || 0;

  if(animated){
    animateNumber(el, current, tot, 1000);
  } else {
    el.textContent = '$' + tot.toFixed(2);
  }
}



function setLang(lang){ STATE.lang = lang; // update static texts
  if(lang==='ru'){
    $('login-title').textContent='–ö—Ä–∏–ø—Ç–æ –∫–æ—à–µ–ª–µ–∫';
    $('login-sub').textContent='–í–æ–π–¥–∏—Ç–µ –ø–æ–¥ —Å–≤–æ–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏.';
    $('btn-login').textContent='–í–æ–π—Ç–∏';
    $('welcome').textContent='–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å,';
    $('btn-logout').textContent='–í—ã–π—Ç–∏';
    $('balance-label').textContent='–û–±—â–∏–π –±–∞–ª–∞–Ω—Å';
  } else {
    $('login-title').textContent='Crypto wallet';
    $('login-sub').textContent='Sign in with your credentials.';
    $('btn-login').textContent='Sign in';
    $('welcome').textContent='Welcome,';
    $('btn-logout').textContent='Logout';
    $('balance-label').textContent='Total balance';
  }
  // re-render UI strings
  renderAssets();
  // if a modal is open, re-open it so its text updates
  if(STATE.currentModal){ const cm = STATE.currentModal; if(cm.type==='asset') openAssetModal(cm.ticker); else if(cm.type==='deposit') showDeposit(cm.ticker); else if(cm.type==='withdraw') showWithdraw(cm.ticker); }
}

function closeModal(){
  const container = $('modal');
  if(!container || !container.firstChild) return;

  const back = container.firstChild; // modal-back
  const modal = back.querySelector('.modal');

  if(modal){
    modal.style.animation = "scaleOut 0.2s ease forwards";
    back.style.animation = "fadeOut 0.2s ease forwards";
    setTimeout(()=>{
      container.style.display = 'none';
      container.innerHTML = '';
      STATE.currentModal = null;
    }, 200); // –≤—Ä–µ–º—è = –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∞–Ω–∏–º–∞—Ü–∏–∏
  } else {
    container.style.display = 'none';
    container.innerHTML = '';
    STATE.currentModal = null;
  }
}


function showMessage(msg){
  const toast = document.getElementById('toast');
  const el = document.createElement('div');
  el.style.cssText = `
    background: rgba(0,0,0,0.85);
    color: #fff;
    padding: 10px 16px;
    border-radius: 8px;
    margin-top: 8px;
    font-size: 14px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    animation: fadeIn 0.3s ease;
  `;
  el.textContent = msg;
  toast.appendChild(el);

  // –ê–≤—Ç–æ–∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏–µ
  setTimeout(()=>{
    el.style.transition = "opacity 0.5s";
    el.style.opacity = "0";
    setTimeout(()=> el.remove(), 500);
  }, 3000);
}



</script>

<div id="toast" style="position:fixed;bottom:20px;right:20px;z-index:2000;"></div>


</body>
</html>